// ============================================================================
// NELNA INTEGRATED MAINTENANCE MANAGEMENT SYSTEM
// Prisma Schema - Production Database Design
// Version: 1.0.0
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// AUTHENTICATION & AUTHORIZATION
// ============================================================================

model Company {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  code        String    @unique @db.VarChar(50)
  address     String?   @db.Text
  phone       String?   @db.VarChar(20)
  email       String?   @db.VarChar(255)
  logo        String?   @db.VarChar(500)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  branches Branch[]
  users    User[]

  @@map("companies")
}

model Branch {
  id          Int       @id @default(autoincrement())
  companyId   Int       @map("company_id")
  name        String    @db.VarChar(255)
  code        String    @unique @db.VarChar(50)
  address     String?   @db.Text
  phone       String?   @db.VarChar(20)
  email       String?   @db.VarChar(255)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  company          Company           @relation(fields: [companyId], references: [id])
  users            User[]
  vehicles         Vehicle[]
  machines         Machine[]
  serviceRequests  ServiceRequest[]
  products         Product[]
  purchaseOrders   PurchaseOrder[]
  assets           Asset[]
  stockMovements   StockMovement[]
  expenses         Expense[]

  @@index([companyId])
  @@map("branches")
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  displayName String   @map("display_name") @db.VarChar(100)
  description String?   @db.Text
  isSystem    Boolean   @default(false) @map("is_system")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          Int       @id @default(autoincrement())
  module      String    @db.VarChar(100)
  action      String    @db.VarChar(100)
  resource    String    @db.VarChar(100)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  roles RolePermission[]

  @@unique([module, action, resource])
  @@map("permissions")
}

model RolePermission {
  id           Int @id @default(autoincrement())
  roleId       Int @map("role_id")
  permissionId Int @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model User {
  id              Int       @id @default(autoincrement())
  companyId       Int       @map("company_id")
  branchId        Int?      @map("branch_id")
  roleId          Int       @map("role_id")
  employeeId      String?   @unique @map("employee_id") @db.VarChar(50)
  firstName       String    @map("first_name") @db.VarChar(100)
  lastName        String    @map("last_name") @db.VarChar(100)
  email           String    @unique @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  phone           String?   @db.VarChar(20)
  avatar          String?   @db.VarChar(500)
  isActive        Boolean   @default(true) @map("is_active")
  lastLoginAt     DateTime? @map("last_login_at")
  passwordResetToken String? @map("password_reset_token") @db.VarChar(255)
  passwordResetExpiry DateTime? @map("password_reset_expiry")
  refreshToken    String?   @map("refresh_token") @db.Text
  fcmToken        String?   @map("fcm_token") @db.VarChar(500)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  company            Company          @relation(fields: [companyId], references: [id])
  branch             Branch?          @relation(fields: [branchId], references: [id])
  role               Role             @relation(fields: [roleId], references: [id])
  vehicleAssignments VehicleDriver[]
  serviceRequests    ServiceRequest[] @relation("ServiceRequester")
  assignedServices   ServiceTask[]    @relation("AssignedTechnician")
  approvedServices   ServiceRequest[] @relation("ServiceApprover")
  auditLogs          AuditLog[]
  notifications      Notification[]
  createdExpenses    Expense[]

  @@index([companyId])
  @@index([branchId])
  @@index([roleId])
  @@index([email])
  @@map("users")
}

// ============================================================================
// VEHICLE MANAGEMENT MODULE
// ============================================================================

model Vehicle {
  id                Int       @id @default(autoincrement())
  branchId          Int       @map("branch_id")
  registrationNo    String    @unique @map("registration_no") @db.VarChar(50)
  make              String    @db.VarChar(100)
  model             String    @db.VarChar(100)
  year              Int?
  engineNo          String?   @map("engine_no") @db.VarChar(100)
  chassisNo         String?   @map("chassis_no") @db.VarChar(100)
  fuelType          FuelType  @default(DIESEL) @map("fuel_type")
  vehicleType       String    @map("vehicle_type") @db.VarChar(50)
  color             String?   @db.VarChar(50)
  mileage           Decimal   @default(0) @db.Decimal(12, 2)
  status            VehicleStatus @default(ACTIVE)
  purchaseDate      DateTime? @map("purchase_date")
  purchasePrice     Decimal?  @map("purchase_price") @db.Decimal(12, 2)
  insuranceExpiry   DateTime? @map("insurance_expiry")
  licenseExpiry     DateTime? @map("license_expiry")
  lastServiceDate   DateTime? @map("last_service_date")
  nextServiceDate   DateTime? @map("next_service_date")
  nextServiceMileage Decimal? @map("next_service_mileage") @db.Decimal(12, 2)
  imageUrl          String?   @map("image_url") @db.VarChar(500)
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  branch            Branch             @relation(fields: [branchId], references: [id])
  documents         VehicleDocument[]
  fuelLogs          FuelLog[]
  serviceHistory    VehicleServiceHistory[]
  drivers           VehicleDriver[]
  serviceRequests   ServiceRequest[]

  @@index([branchId])
  @@index([registrationNo])
  @@index([status])
  @@map("vehicles")
}

model VehicleDocument {
  id          Int       @id @default(autoincrement())
  vehicleId   Int       @map("vehicle_id")
  type        DocumentType
  documentNo  String    @map("document_no") @db.VarChar(100)
  issueDate   DateTime  @map("issue_date")
  expiryDate  DateTime  @map("expiry_date")
  provider    String?   @db.VarChar(255)
  amount      Decimal?  @db.Decimal(12, 2)
  fileUrl     String?   @map("file_url") @db.VarChar(500)
  notes       String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([expiryDate])
  @@map("vehicle_documents")
}

model FuelLog {
  id            Int       @id @default(autoincrement())
  vehicleId     Int       @map("vehicle_id")
  date          DateTime
  fuelType      FuelType  @map("fuel_type")
  quantity      Decimal   @db.Decimal(10, 2)
  unitPrice     Decimal   @map("unit_price") @db.Decimal(10, 2)
  totalCost     Decimal   @map("total_cost") @db.Decimal(12, 2)
  mileage       Decimal   @db.Decimal(12, 2)
  station       String?   @db.VarChar(255)
  receiptNo     String?   @map("receipt_no") @db.VarChar(100)
  receiptUrl    String?   @map("receipt_url") @db.VarChar(500)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([date])
  @@map("fuel_logs")
}

model VehicleServiceHistory {
  id             Int       @id @default(autoincrement())
  vehicleId      Int       @map("vehicle_id")
  serviceDate    DateTime  @map("service_date")
  serviceType    String    @map("service_type") @db.VarChar(100)
  description    String    @db.Text
  mileageAtService Decimal @map("mileage_at_service") @db.Decimal(12, 2)
  cost           Decimal   @db.Decimal(12, 2)
  serviceProvider String?  @map("service_provider") @db.VarChar(255)
  invoiceNo      String?   @map("invoice_no") @db.VarChar(100)
  nextServiceDate DateTime? @map("next_service_date")
  nextServiceMileage Decimal? @map("next_service_mileage") @db.Decimal(12, 2)
  notes          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([serviceDate])
  @@map("vehicle_service_history")
}

model VehicleDriver {
  id          Int       @id @default(autoincrement())
  vehicleId   Int       @map("vehicle_id")
  driverId    Int       @map("driver_id")
  assignedDate DateTime @map("assigned_date")
  releasedDate DateTime? @map("released_date")
  isActive    Boolean   @default(true) @map("is_active")
  notes       String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
  driver  User    @relation(fields: [driverId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@map("vehicle_drivers")
}

// ============================================================================
// MACHINE MAINTENANCE MODULE
// ============================================================================

model Machine {
  id                  Int       @id @default(autoincrement())
  branchId            Int       @map("branch_id")
  machineCode         String    @unique @map("machine_code") @db.VarChar(50)
  name                String    @db.VarChar(255)
  category            String?   @db.VarChar(100)
  manufacturer        String?   @db.VarChar(255)
  modelNumber         String?   @map("model_number") @db.VarChar(100)
  serialNumber        String?   @map("serial_number") @db.VarChar(100)
  purchaseDate        DateTime? @map("purchase_date")
  purchasePrice       Decimal?  @map("purchase_price") @db.Decimal(12, 2)
  warrantyExpiry      DateTime? @map("warranty_expiry")
  location            String?   @db.VarChar(255)
  department          String?   @db.VarChar(100)
  status              MachineStatus @default(OPERATIONAL)
  criticality         Criticality @default(MEDIUM)
  operatingHours      Decimal   @default(0) @map("operating_hours") @db.Decimal(10, 2)
  lastMaintenanceDate DateTime? @map("last_maintenance_date")
  nextMaintenanceDate DateTime? @map("next_maintenance_date")
  maintenanceInterval Int?      @map("maintenance_interval_days")
  qrCode              String?   @map("qr_code") @db.VarChar(500)
  imageUrl            String?   @map("image_url") @db.VarChar(500)
  specifications      Json?
  notes               String?   @db.Text
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  deletedAt           DateTime? @map("deleted_at")

  branch              Branch                @relation(fields: [branchId], references: [id])
  maintenanceSchedules MachineMaintenanceSchedule[]
  breakdownLogs       BreakdownLog[]
  amcContracts        AMCContract[]
  machineServiceHistory MachineServiceHistory[]
  serviceRequests     ServiceRequest[]

  @@index([branchId])
  @@index([machineCode])
  @@index([status])
  @@map("machines")
}

model MachineMaintenanceSchedule {
  id                Int       @id @default(autoincrement())
  machineId         Int       @map("machine_id")
  maintenanceType   String    @map("maintenance_type") @db.VarChar(100)
  description       String    @db.Text
  frequencyDays     Int       @map("frequency_days")
  frequencyHours    Int?      @map("frequency_hours")
  lastPerformedDate DateTime? @map("last_performed_date")
  nextDueDate       DateTime  @map("next_due_date")
  assignedTeam      String?   @map("assigned_team") @db.VarChar(100)
  estimatedDuration Int?      @map("estimated_duration_minutes")
  estimatedCost     Decimal?  @map("estimated_cost") @db.Decimal(12, 2)
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  machine Machine @relation(fields: [machineId], references: [id])

  @@index([machineId])
  @@index([nextDueDate])
  @@map("machine_maintenance_schedules")
}

model BreakdownLog {
  id                Int       @id @default(autoincrement())
  machineId         Int       @map("machine_id")
  reportedAt        DateTime  @map("reported_at")
  resolvedAt        DateTime? @map("resolved_at")
  severity          Severity  @default(MEDIUM)
  description       String    @db.Text
  rootCause         String?   @map("root_cause") @db.Text
  resolution        String?   @db.Text
  downtimeMinutes   Int?      @map("downtime_minutes")
  costOfRepair      Decimal?  @map("cost_of_repair") @db.Decimal(12, 2)
  reportedBy        String?   @map("reported_by") @db.VarChar(100)
  resolvedBy        String?   @map("resolved_by") @db.VarChar(100)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  machine Machine @relation(fields: [machineId], references: [id])

  @@index([machineId])
  @@index([reportedAt])
  @@map("breakdown_logs")
}

model AMCContract {
  id                Int       @id @default(autoincrement())
  machineId         Int       @map("machine_id")
  contractNo        String    @unique @map("contract_no") @db.VarChar(100)
  vendor            String    @db.VarChar(255)
  startDate         DateTime  @map("start_date")
  endDate           DateTime  @map("end_date")
  annualCost        Decimal   @map("annual_cost") @db.Decimal(12, 2)
  coverageDetails   String?   @map("coverage_details") @db.Text
  contactPerson     String?   @map("contact_person") @db.VarChar(100)
  contactPhone      String?   @map("contact_phone") @db.VarChar(20)
  documentUrl       String?   @map("document_url") @db.VarChar(500)
  status            AMCStatus @default(ACTIVE)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  machine Machine @relation(fields: [machineId], references: [id])

  @@index([machineId])
  @@index([endDate])
  @@map("amc_contracts")
}

model MachineServiceHistory {
  id             Int       @id @default(autoincrement())
  machineId      Int       @map("machine_id")
  serviceDate    DateTime  @map("service_date")
  serviceType    String    @map("service_type") @db.VarChar(100)
  description    String    @db.Text
  hoursAtService Decimal?  @map("hours_at_service") @db.Decimal(10, 2)
  cost           Decimal   @db.Decimal(12, 2)
  performedBy    String?   @map("performed_by") @db.VarChar(100)
  notes          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  machine Machine @relation(fields: [machineId], references: [id])

  @@index([machineId])
  @@map("machine_service_history")
}

// ============================================================================
// SERVICE MANAGEMENT MODULE
// ============================================================================

model ServiceRequest {
  id                Int       @id @default(autoincrement())
  branchId          Int       @map("branch_id")
  ticketNo          String    @unique @map("ticket_no") @db.VarChar(50)
  requesterId       Int       @map("requester_id")
  approverId        Int?      @map("approver_id")
  vehicleId         Int?      @map("vehicle_id")
  machineId         Int?      @map("machine_id")
  assetId           Int?      @map("asset_id")
  category          ServiceCategory
  priority          Priority  @default(MEDIUM)
  subject           String    @db.VarChar(255)
  description       String    @db.Text
  status            ServiceStatus @default(PENDING)
  approvedAt        DateTime? @map("approved_at")
  rejectedReason    String?   @map("rejected_reason") @db.Text
  estimatedCost     Decimal?  @map("estimated_cost") @db.Decimal(12, 2)
  actualCost        Decimal?  @map("actual_cost") @db.Decimal(12, 2)
  slaDeadline       DateTime? @map("sla_deadline")
  completedAt       DateTime? @map("completed_at")
  closedAt          DateTime? @map("closed_at")
  closedReason      String?   @map("closed_reason") @db.Text
  reportUrl         String?   @map("report_url") @db.VarChar(500)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  branch    Branch   @relation(fields: [branchId], references: [id])
  requester User     @relation("ServiceRequester", fields: [requesterId], references: [id])
  approver  User?    @relation("ServiceApprover", fields: [approverId], references: [id])
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])
  machine   Machine? @relation(fields: [machineId], references: [id])
  asset     Asset?   @relation(fields: [assetId], references: [id])
  tasks     ServiceTask[]
  spareParts ServiceSparePart[]

  @@index([branchId])
  @@index([requesterId])
  @@index([status])
  @@index([ticketNo])
  @@index([slaDeadline])
  @@map("service_requests")
}

model ServiceTask {
  id                Int       @id @default(autoincrement())
  serviceRequestId  Int       @map("service_request_id")
  technicianId      Int       @map("technician_id")
  taskDescription   String    @map("task_description") @db.Text
  status            TaskStatus @default(ASSIGNED)
  startedAt         DateTime? @map("started_at")
  completedAt       DateTime? @map("completed_at")
  timeSpentMinutes  Int?      @map("time_spent_minutes")
  laborCost         Decimal?  @map("labor_cost") @db.Decimal(12, 2)
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  technician     User           @relation("AssignedTechnician", fields: [technicianId], references: [id])

  @@index([serviceRequestId])
  @@index([technicianId])
  @@map("service_tasks")
}

model ServiceSparePart {
  id                Int     @id @default(autoincrement())
  serviceRequestId  Int     @map("service_request_id")
  productId         Int     @map("product_id")
  quantity          Decimal @db.Decimal(10, 2)
  unitCost          Decimal @map("unit_cost") @db.Decimal(12, 2)
  totalCost         Decimal @map("total_cost") @db.Decimal(12, 2)
  createdAt         DateTime @default(now()) @map("created_at")

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  product        Product        @relation(fields: [productId], references: [id])

  @@index([serviceRequestId])
  @@map("service_spare_parts")
}

// ============================================================================
// INVENTORY MANAGEMENT MODULE
// ============================================================================

model ProductCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(255)
  description String?   @db.Text
  parentId    Int?      @map("parent_id")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@index([parentId])
  @@map("product_categories")
}

model Product {
  id                Int       @id @default(autoincrement())
  branchId          Int       @map("branch_id")
  categoryId        Int?      @map("category_id")
  sku               String    @unique @db.VarChar(100)
  barcode           String?   @unique @db.VarChar(100)
  name              String    @db.VarChar(255)
  description       String?   @db.Text
  unit              String    @db.VarChar(50)
  unitPrice         Decimal   @map("unit_price") @db.Decimal(12, 2)
  costPrice         Decimal?  @map("cost_price") @db.Decimal(12, 2)
  currentStock      Decimal   @default(0) @map("current_stock") @db.Decimal(12, 2)
  minimumStock      Decimal   @default(0) @map("minimum_stock") @db.Decimal(12, 2)
  maximumStock      Decimal?  @map("maximum_stock") @db.Decimal(12, 2)
  reorderLevel      Decimal   @default(0) @map("reorder_level") @db.Decimal(12, 2)
  reorderQuantity   Decimal?  @map("reorder_quantity") @db.Decimal(12, 2)
  location          String?   @db.VarChar(100)
  imageUrl          String?   @map("image_url") @db.VarChar(500)
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  branch         Branch          @relation(fields: [branchId], references: [id])
  category       ProductCategory? @relation(fields: [categoryId], references: [id])
  stockMovements StockMovement[]
  spareParts     ServiceSparePart[]
  purchaseItems  PurchaseOrderItem[]
  grnItems       GRNItem[]

  @@index([branchId])
  @@index([categoryId])
  @@index([sku])
  @@index([currentStock])
  @@map("products")
}

model StockMovement {
  id            Int       @id @default(autoincrement())
  branchId      Int       @map("branch_id")
  productId     Int       @map("product_id")
  type          StockMovementType
  quantity      Decimal   @db.Decimal(12, 2)
  unitCost      Decimal?  @map("unit_cost") @db.Decimal(12, 2)
  referenceType String?   @map("reference_type") @db.VarChar(50)
  referenceId   Int?      @map("reference_id")
  reason        String?   @db.Text
  previousStock Decimal   @map("previous_stock") @db.Decimal(12, 2)
  newStock      Decimal   @map("new_stock") @db.Decimal(12, 2)
  performedBy   String?   @map("performed_by") @db.VarChar(100)
  createdAt     DateTime  @default(now()) @map("created_at")

  branch  Branch  @relation(fields: [branchId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([branchId])
  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

model Supplier {
  id            Int       @id @default(autoincrement())
  name          String    @db.VarChar(255)
  code          String    @unique @db.VarChar(50)
  contactPerson String?   @map("contact_person") @db.VarChar(100)
  email         String?   @db.VarChar(255)
  phone         String?   @db.VarChar(20)
  address       String?   @db.Text
  taxId         String?   @map("tax_id") @db.VarChar(50)
  bankDetails   String?   @map("bank_details") @db.Text
  paymentTerms  String?   @map("payment_terms") @db.VarChar(100)
  rating        Int?      @default(0)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  purchaseOrders PurchaseOrder[]
  grns           GRN[]

  @@map("suppliers")
}

model PurchaseOrder {
  id              Int       @id @default(autoincrement())
  branchId        Int       @map("branch_id")
  supplierId      Int       @map("supplier_id")
  poNumber        String    @unique @map("po_number") @db.VarChar(50)
  orderDate       DateTime  @map("order_date")
  expectedDate    DateTime? @map("expected_date")
  status          POStatus  @default(DRAFT)
  subtotal        Decimal   @default(0) @db.Decimal(12, 2)
  taxAmount       Decimal   @default(0) @map("tax_amount") @db.Decimal(12, 2)
  discountAmount  Decimal   @default(0) @map("discount_amount") @db.Decimal(12, 2)
  totalAmount     Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  notes           String?   @db.Text
  approvedBy      String?   @map("approved_by") @db.VarChar(100)
  approvedAt      DateTime? @map("approved_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  branch   Branch   @relation(fields: [branchId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]
  grns     GRN[]

  @@index([branchId])
  @@index([supplierId])
  @@index([poNumber])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              Int     @id @default(autoincrement())
  purchaseOrderId Int     @map("purchase_order_id")
  productId       Int     @map("product_id")
  quantity        Decimal @db.Decimal(12, 2)
  unitPrice       Decimal @map("unit_price") @db.Decimal(12, 2)
  totalPrice      Decimal @map("total_price") @db.Decimal(12, 2)
  receivedQty     Decimal @default(0) @map("received_qty") @db.Decimal(12, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model GRN {
  id              Int       @id @default(autoincrement())
  purchaseOrderId Int       @map("purchase_order_id")
  supplierId      Int       @map("supplier_id")
  grnNumber       String    @unique @map("grn_number") @db.VarChar(50)
  receivedDate    DateTime  @map("received_date")
  invoiceNo       String?   @map("invoice_no") @db.VarChar(100)
  notes           String?   @db.Text
  receivedBy      String?   @map("received_by") @db.VarChar(100)
  status          GRNStatus @default(PENDING)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  supplier      Supplier      @relation(fields: [supplierId], references: [id])
  items         GRNItem[]

  @@index([purchaseOrderId])
  @@map("grns")
}

model GRNItem {
  id            Int     @id @default(autoincrement())
  grnId         Int     @map("grn_id")
  productId     Int     @map("product_id")
  orderedQty    Decimal @map("ordered_qty") @db.Decimal(12, 2)
  receivedQty   Decimal @map("received_qty") @db.Decimal(12, 2)
  acceptedQty   Decimal @map("accepted_qty") @db.Decimal(12, 2)
  rejectedQty   Decimal @default(0) @map("rejected_qty") @db.Decimal(12, 2)
  rejectReason  String? @map("reject_reason") @db.Text
  unitCost      Decimal @map("unit_cost") @db.Decimal(12, 2)

  grn     GRN     @relation(fields: [grnId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([grnId])
  @@map("grn_items")
}

// ============================================================================
// STORES / ASSET MANAGEMENT MODULE
// ============================================================================

model Asset {
  id                Int       @id @default(autoincrement())
  branchId          Int       @map("branch_id")
  assetCode         String    @unique @map("asset_code") @db.VarChar(50)
  name              String    @db.VarChar(255)
  category          String    @db.VarChar(100)
  location          String?   @db.VarChar(255)
  department        String?   @db.VarChar(100)
  serialNumber      String?   @map("serial_number") @db.VarChar(100)
  purchaseDate      DateTime? @map("purchase_date")
  purchasePrice     Decimal?  @map("purchase_price") @db.Decimal(12, 2)
  currentValue      Decimal?  @map("current_value") @db.Decimal(12, 2)
  depreciationRate  Decimal?  @map("depreciation_rate") @db.Decimal(5, 2)
  warrantyExpiry    DateTime? @map("warranty_expiry")
  condition         AssetCondition @default(GOOD)
  status            AssetStatus @default(IN_USE)
  assignedTo        String?   @map("assigned_to") @db.VarChar(100)
  imageUrl          String?   @map("image_url") @db.VarChar(500)
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  branch          Branch             @relation(fields: [branchId], references: [id])
  repairLogs      AssetRepairLog[]
  transfers       AssetTransfer[]
  serviceRequests ServiceRequest[]

  @@index([branchId])
  @@index([assetCode])
  @@index([status])
  @@map("assets")
}

model AssetRepairLog {
  id            Int       @id @default(autoincrement())
  assetId       Int       @map("asset_id")
  repairDate    DateTime  @map("repair_date")
  description   String    @db.Text
  cost          Decimal   @db.Decimal(12, 2)
  vendor        String?   @db.VarChar(255)
  completedDate DateTime? @map("completed_date")
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  asset Asset @relation(fields: [assetId], references: [id])

  @@index([assetId])
  @@map("asset_repair_logs")
}

model AssetTransfer {
  id              Int       @id @default(autoincrement())
  assetId         Int       @map("asset_id")
  fromLocation    String    @map("from_location") @db.VarChar(255)
  toLocation      String    @map("to_location") @db.VarChar(255)
  fromDepartment  String?   @map("from_department") @db.VarChar(100)
  toDepartment    String?   @map("to_department") @db.VarChar(100)
  transferDate    DateTime  @map("transfer_date")
  reason          String?   @db.Text
  approvedBy      String?   @map("approved_by") @db.VarChar(100)
  createdAt       DateTime  @default(now()) @map("created_at")

  asset Asset @relation(fields: [assetId], references: [id])

  @@index([assetId])
  @@map("asset_transfers")
}

// ============================================================================
// FINANCIAL / EXPENSE MODULE
// ============================================================================

model Expense {
  id              Int       @id @default(autoincrement())
  branchId        Int       @map("branch_id")
  createdById     Int       @map("created_by_id")
  expenseNo       String    @unique @map("expense_no") @db.VarChar(50)
  category        ExpenseCategory
  referenceType   String?   @map("reference_type") @db.VarChar(50)
  referenceId     Int?      @map("reference_id")
  description     String    @db.Text
  amount          Decimal   @db.Decimal(12, 2)
  date            DateTime
  invoiceNo       String?   @map("invoice_no") @db.VarChar(100)
  vendor          String?   @db.VarChar(255)
  receiptUrl      String?   @map("receipt_url") @db.VarChar(500)
  status          ExpenseStatus @default(PENDING)
  approvedBy      String?   @map("approved_by") @db.VarChar(100)
  approvedAt      DateTime? @map("approved_at")
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  branch    Branch @relation(fields: [branchId], references: [id])
  createdBy User   @relation(fields: [createdById], references: [id])

  @@index([branchId])
  @@index([category])
  @@index([date])
  @@map("expenses")
}

// ============================================================================
// SYSTEM MODULES
// ============================================================================

model AuditLog {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  action      String   @db.VarChar(50)
  module      String   @db.VarChar(100)
  entityType  String   @map("entity_type") @db.VarChar(100)
  entityId    Int?     @map("entity_id")
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([module])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  title     String    @db.VarChar(255)
  body      String    @db.Text
  type      String    @db.VarChar(50)
  data      Json?
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model SystemConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String   @db.Text
  type      String   @default("string") @db.VarChar(20)
  module    String?  @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// ============================================================================
// ENUMS
// ============================================================================

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  CNG
  LPG
}

enum VehicleStatus {
  ACTIVE
  IN_SERVICE
  OUT_OF_SERVICE
  DISPOSED
  RESERVED
}

enum DocumentType {
  INSURANCE
  LICENSE
  REGISTRATION
  EMISSION
  FITNESS
  PERMIT
  OTHER
}

enum MachineStatus {
  OPERATIONAL
  UNDER_MAINTENANCE
  BREAKDOWN
  DECOMMISSIONED
  STANDBY
}

enum Criticality {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ServiceCategory {
  VEHICLE_SERVICE
  MACHINE_MAINTENANCE
  ASSET_REPAIR
  PREVENTIVE_MAINTENANCE
  EMERGENCY_REPAIR
  INSPECTION
  GENERAL
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
  CRITICAL
}

enum ServiceStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CLOSED
  CANCELLED
}

enum TaskStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum StockMovementType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGE
  EXPIRED
}

enum POStatus {
  DRAFT
  SUBMITTED
  APPROVED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  CLOSED
}

enum GRNStatus {
  PENDING
  INSPECTING
  ACCEPTED
  PARTIALLY_ACCEPTED
  REJECTED
}

enum AMCStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING_RENEWAL
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
  SCRAP
}

enum AssetStatus {
  IN_USE
  IN_STORAGE
  UNDER_REPAIR
  DISPOSED
  TRANSFERRED
  LOST
}

enum ExpenseCategory {
  VEHICLE_MAINTENANCE
  MACHINE_MAINTENANCE
  FUEL
  SPARE_PARTS
  LABOR
  INSURANCE
  LICENSE
  AMC
  ASSET_REPAIR
  GENERAL
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}
